<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portflux.backend.mapper.BoardFreeMapper">

    <select id="checkLike" resultType="int">
        SELECT COUNT(*) FROM POST_LIKE 
        WHERE post_id = #{postId} 
        AND 
        <choose>
            <when test="role == 'COMPANY'">company_num = #{companyNum}</when>
            <otherwise>user_num = #{userNum}</otherwise>
        </choose>
    </select>

    <insert id="insertLike">
        INSERT INTO POST_LIKE (post_id, user_num, company_num, liked_at) 
        VALUES (
            #{postId}, 
            <choose>
                <when test="role == 'COMPANY'">NULL, #{companyNum}</when>
                <otherwise>#{userNum}, NULL</otherwise>
            </choose>, 
            SYSDATE
        )
    </insert>

    <delete id="deleteLike">
        DELETE FROM POST_LIKE 
        WHERE post_id = #{postId} 
        AND 
        <choose>
            <when test="role == 'COMPANY'">company_num = #{companyNum}</when>
            <otherwise>user_num = #{userNum}</otherwise>
        </choose>
    </delete>

    <update id="increaseLikeCount" parameterType="int">
        UPDATE POST SET like_cnt = NVL(like_cnt, 0) + 1 WHERE post_id = #{postId}
    </update>

    <update id="decreaseLikeCount" parameterType="int">
        UPDATE POST SET like_cnt = CASE WHEN NVL(like_cnt, 0) > 0 THEN like_cnt - 1 ELSE 0 END WHERE post_id = #{postId}
    </update>

    <select id="getBoardList" parameterType="String" resultType="com.portflux.backend.beans.BoardFreeBean">
    SELECT p.post_id as postId,
           p.board_type as boardType,
           p.title,
           p.content,
           p.created_at as createdAt,
           NVL(p.view_cnt, 0) as viewCnt,
           NVL(p.like_cnt, 0) as likeCnt,
           p.post_file as postFile,
           p.image as image,
           p.user_num as userNum,
           p.company_num as companyNum,
           COALESCE(u.user_nickname, c.company_name, '관리자') as userNickname,
           COALESCE(u.user_nickname, c.company_name, '관리자') as writerNickname,
           (SELECT COUNT(*) FROM POST_COMMENT com WHERE com.post_id = p.post_id) as commentCnt
    FROM POST p
    LEFT JOIN USERS u ON p.user_num = u.user_num
    LEFT JOIN COMPANY c ON p.company_num = c.company_num
    LEFT JOIN ADMIN_ACCOUNT a ON p.user_num = a.user_num
    <where>
        <if test="keyword != null and keyword != ''">
            (p.title LIKE '%' || #{keyword} || '%' OR p.content LIKE '%' || #{keyword} || '%')
        </if>
        AND p.board_type IN ('free', 'notice')
    </where>
    ORDER BY CASE WHEN p.board_type = 'notice' THEN 0 ELSE 1 END ASC, p.created_at DESC, p.post_id DESC
</select>

<select id="getBoardDetail" parameterType="int" resultType="com.portflux.backend.beans.BoardFreeBean">
    SELECT 
        p.post_id as postId, 
        p.board_type as boardType, 
        p.title, 
        p.content, 
        p.created_at as createdAt, 
        p.updated_at as updatedAt,
        NVL(p.view_cnt, 0) as viewCnt, 
        NVL(p.like_cnt, 0) as likeCnt,
        p.post_file as postFile,
        p.image as image,
        p.user_num as userNum,
        p.company_num as companyNum,
        COALESCE(u.user_nickname, c.company_name, '관리자') as userNickname,
        COALESCE(u.user_nickname, c.company_name, '관리자') as writerNickname
    FROM POST p 
    LEFT JOIN USERS u ON p.user_num = u.user_num
    LEFT JOIN COMPANY c ON p.company_num = c.company_num
    LEFT JOIN ADMIN_ACCOUNT a ON p.user_num = a.user_num
    WHERE p.post_id = #{postId}
</select>

    <insert id="insertBoard" parameterType="com.portflux.backend.beans.BoardFreeBean">
        INSERT INTO POST (board_type, user_num, company_num, title, content, post_file, image) 
        VALUES (#{boardType}, #{userNum, jdbcType=INTEGER}, #{companyNum, jdbcType=INTEGER}, #{title}, #{content}, #{postFile, jdbcType=VARCHAR}, #{image, jdbcType=VARCHAR})
    </insert>

    <update id="increaseViewCount" parameterType="int">
        UPDATE POST SET view_cnt = NVL(view_cnt, 0) + 1 WHERE post_id = #{postId}
    </update>

    <update id="updateBoard" parameterType="com.portflux.backend.beans.BoardFreeBean">
        UPDATE POST SET title = #{title}, content = #{content},
        post_file = #{postFile, jdbcType=VARCHAR},
        image = #{image, jdbcType=VARCHAR}
        WHERE post_id = #{postId}
    </update>

    <delete id="deleteBoard" parameterType="int">
        DELETE FROM POST WHERE post_id = #{postId}
    </delete>

    <select id="getCommentList" parameterType="int" resultType="com.portflux.backend.beans.BoardCommentBean">
        SELECT c.comment_id as commentId, c.post_id as postId, c.user_num as userNum, c.company_num as companyNum,
               c.comment_content as content, c.comment_created_at as createdAt,
               c.comment_modify_at as modifyAt, c.parent_id as parentId, 
               COALESCE(u.user_nickname, comp.company_name, '알 수 없음') as userNickname
        FROM POST_COMMENT c 
        LEFT JOIN USERS u ON c.user_num = u.user_num
        LEFT JOIN COMPANY comp ON c.company_num = comp.company_num
        WHERE c.post_id = #{postId} ORDER BY c.comment_id ASC
    </select>

    <insert id="insertComment" parameterType="com.portflux.backend.beans.BoardCommentBean">
        INSERT INTO POST_COMMENT (user_num, company_num, post_id, comment_content, comment_created_at, parent_id)
        VALUES (
            #{userNum, jdbcType=INTEGER}, 
            #{companyNum, jdbcType=INTEGER}, 
            #{postId}, 
            #{content}, 
            SYSDATE, 
            #{parentId, jdbcType=INTEGER}
        )
    </insert>

    <delete id="deleteComment" parameterType="int">
        DELETE FROM POST_COMMENT WHERE comment_id = #{commentId}
    </delete>

    <update id="updateComment" parameterType="com.portflux.backend.beans.BoardCommentBean">
        UPDATE POST_COMMENT SET comment_content = #{content}, comment_modify_at = SYSDATE WHERE comment_id = #{commentId}
    </update>

</mapper>