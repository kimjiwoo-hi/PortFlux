<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portflux.backend.mapper.BoardLookupMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="BoardLookupPostResultMap" type="com.portflux.backend.dto.BoardLookupPostDto">
        <id property="postId" column="post_id"/>
        <result property="boardType" column="board_type"/>
        <result property="userNum" column="user_num"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="viewCnt" column="view_cnt"/>
        <result property="price" column="price"/>
        <result property="aiSummary" column="ai_summary"/>
        <result property="downloadCnt" column="download_cnt"/>
        <result property="postFile" column="post_file"/>
        <result property="tags" column="tags"/>
        <result property="userNickname" column="user_nickname"/>
        <result property="userImage" column="user_image"/>
    </resultMap>

    <!-- 게시글 상세 조회 (일반회원 + 기업회원) -->
    <select id="findPostById" parameterType="int" resultMap="BoardLookupPostResultMap">
        SELECT
            p.post_id,
            p.board_type,
            p.user_num,
            p.title,
            p.content,
            p.created_at,
            p.updated_at,
            p.view_cnt,
            p.price,
            p.ai_summary,
            p.download_cnt,
            p.post_file,
            p.tags,
            COALESCE(u.user_nickname, c.company_name) as user_nickname,
            u.user_image
        FROM POST p
        LEFT JOIN USERS u ON p.user_num = u.user_num
        LEFT JOIN COMPANY c ON p.user_num = c.company_num
        WHERE p.post_id = #{postId}
          AND p.board_type = 'lookup'
    </select>

    <!-- 전체 게시글 목록 조회 (일반회원 + 기업회원) -->
    <select id="findAllLookupPosts" resultMap="BoardLookupPostResultMap">
        SELECT
            p.post_id,
            p.board_type,
            p.user_num,
            p.title,
            p.content,
            p.created_at,
            p.updated_at,
            p.view_cnt,
            p.price,
            p.ai_summary,
            p.download_cnt,
            p.post_file,
            p.tags,
            COALESCE(u.user_nickname, c.company_name) as user_nickname,
            u.user_image
        FROM POST p
        LEFT JOIN USERS u ON p.user_num = u.user_num
        LEFT JOIN COMPANY c ON p.user_num = c.company_num
        WHERE p.board_type = 'lookup'
        ORDER BY p.created_at DESC
    </select>

    <!-- 조회수 증가 -->
    <update id="incrementViewCount" parameterType="int">
        UPDATE POST
        SET view_cnt = view_cnt + 1
        WHERE post_id = #{postId}
    </update>

    <!-- 게시글 작성 -->
    <insert id="insertPost" parameterType="com.portflux.backend.dto.BoardLookupPostDto"
            useGeneratedKeys="true" keyProperty="postId" keyColumn="post_id">
        INSERT INTO POST (
            board_type,
            user_num,
            title,
            content,
            created_at,
            updated_at,
            view_cnt,
            price,
            ai_summary,
            download_cnt,
            post_file,
            tags
        ) VALUES (
            'lookup',
            #{userNum},
            #{title},
            #{content},
            SYSDATE,
            SYSDATE,
            #{viewCnt},
            #{price},
            #{aiSummary, jdbcType=VARCHAR},
            #{downloadCnt},
            #{postFile},
            #{tags}
        )
    </insert>

    <!-- 게시글 수정 -->
    <update id="updatePost" parameterType="com.portflux.backend.dto.BoardLookupPostDto">
        UPDATE POST
        SET 
            title = #{title},
            content = #{content},
            price = #{price},
            ai_summary = #{aiSummary, jdbcType=VARCHAR},
            <if test="postFile != null">
                post_file = #{postFile},
            </if>
            tags = #{tags},
            updated_at = SYSDATE
        WHERE post_id = #{postId}
          AND board_type = 'lookup'
    </update>

    <!-- 게시글 삭제 -->
    <delete id="deletePost" parameterType="int">
        DELETE FROM POST
        WHERE post_id = #{postId}
          AND board_type = 'lookup'
    </delete>

    <!-- 특정 사용자의 게시글 목록 조회 -->
    <select id="findPostsByUserNum" parameterType="int" resultMap="BoardLookupPostResultMap">
        SELECT
            p.post_id,
            p.board_type,
            p.user_num,
            p.title,
            p.content,
            p.created_at,
            p.updated_at,
            p.view_cnt,
            p.price,
            p.ai_summary,
            p.download_cnt,
            p.post_file,
            p.tags,
            u.user_nickname,
            u.user_image
        FROM POST p
        LEFT JOIN USERS u ON p.user_num = u.user_num
        WHERE p.user_num = #{userNum}
        ORDER BY p.created_at DESC
    </select>

    <!-- 닉네임으로 사용자의 게시글 목록 조회 (일반회원 + 기업회원) -->
    <select id="findPostsByNickname" parameterType="string" resultMap="BoardLookupPostResultMap">
        SELECT
            p.post_id,
            p.board_type,
            p.user_num,
            p.title,
            p.content,
            p.created_at,
            p.updated_at,
            p.view_cnt,
            p.price,
            p.ai_summary,
            p.download_cnt,
            p.post_file,
            p.tags,
            COALESCE(u.user_nickname, c.company_name) as user_nickname,
            u.user_image
        FROM POST p
        LEFT JOIN USERS u ON p.user_num = u.user_num
        LEFT JOIN COMPANY c ON p.user_num = c.company_num
        WHERE u.user_nickname = #{nickname} OR c.company_name = #{nickname}
        ORDER BY p.created_at DESC
    </select>

<!-- 구매 여부 확인 -->
<select id="checkPurchaseStatus" resultType="boolean">
    SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
    FROM ORDER_ITEMS oi
    INNER JOIN ORDERS o ON oi.order_id = o.id
    WHERE o.user_id = #{userNum}
    AND oi.product_id = #{postId}
    AND o.status = 'PAID'
</select>

<!-- 다운로드 카운트 증가 -->
<update id="incrementDownloadCount">
    UPDATE POST
    SET download_cnt = download_cnt + 1
    WHERE post_id = #{postId}
</update>
</mapper>