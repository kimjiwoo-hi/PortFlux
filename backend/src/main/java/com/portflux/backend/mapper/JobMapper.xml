<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.portflux.backend.repository.JobRepository">
    
    <!-- Result Map -->
    <resultMap id="JobResultMap" type="com.portflux.backend.dto.JobDto">
        <id property="postId" column="POST_ID"/>
        <result property="companyNum" column="COMPANY_NUM"/>
        <result property="companyName" column="COMPANY_NAME"/>
        <result property="companyImage" column="COMPANY_IMAGE"/>
        <result property="companyLogo" column="COMPANY_LOGO"/>
        <result property="companyPhone" column="COMPANY_PHONE"/>
        <result property="title" column="TITLE"/>
        <result property="content" column="CONTENT"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="viewCnt" column="VIEW_CNT"/>
        <result property="jobRegion" column="JOB_REGION"/>
        <result property="jobCareerType" column="JOB_CAREER_TYPE" 
                typeHandler="com.portflux.backend.handler.JsonArrayTypeHandler"/>
        <result property="jobCareerYears" column="JOB_CAREER_YEARS" 
                typeHandler="com.portflux.backend.handler.JsonArrayTypeHandler"/>
        <result property="jobEducation" column="JOB_EDUCATION"/>
        <result property="jobEducationExclude" column="JOB_EDUCATION_EXCLUDE" 
                typeHandler="org.apache.ibatis.type.BooleanTypeHandler"/>
        <result property="jobSalaryMin" column="JOB_SALARY_MIN"/>
        <result property="jobSalaryMax" column="JOB_SALARY_MAX"/>
        <result property="jobDeadline" column="JOB_DEADLINE"/>
        <result property="jobStatus" column="JOB_STATUS"/>
        <result property="jobIndustries" column="JOB_INDUSTRIES" 
                typeHandler="com.portflux.backend.handler.JsonArrayTypeHandler"/>
        <result property="jobCompanyTypes" column="JOB_COMPANY_TYPES" 
                typeHandler="com.portflux.backend.handler.JsonArrayTypeHandler"/>
        <result property="jobWorkTypes" column="JOB_WORK_TYPES" 
                typeHandler="com.portflux.backend.handler.JsonArrayTypeHandler"/>
        <result property="jobWorkDays" column="JOB_WORK_DAYS" 
                typeHandler="com.portflux.backend.handler.JsonArrayTypeHandler"/>
    </resultMap>
    
    <!-- 동적 필터 조건 -->
    <sql id="filterConditions">
        <where>
            p.BOARD_TYPE = 'job'
            AND p.JOB_STATUS = 'ACTIVE'
            AND p.JOB_DEADLINE >= TRUNC(SYSDATE)
            
            <!-- 지역 필터 -->
            <if test="filter.regions != null and filter.regions.size() > 0">
                AND p.JOB_REGION IN
                <foreach collection="filter.regions" item="region" open="(" separator="," close=")">
                    #{region}
                </foreach>
            </if>
            
            <!-- 경력 타입 필터 -->
            <if test="filter.careerType != null and filter.careerType.size() > 0">
                AND (
                <foreach collection="filter.careerType" item="type" separator=" OR ">
                    p.JOB_CAREER_TYPE LIKE '%' || #{type} || '%'
                </foreach>
                )
            </if>
            
            <!-- 경력 연차 필터 -->
            <if test="filter.careerYears != null and filter.careerYears.size() > 0">
                AND (
                <foreach collection="filter.careerYears" item="years" separator=" OR ">
                    p.JOB_CAREER_YEARS LIKE '%' || #{years} || '%'
                </foreach>
                )
            </if>
            
            <!-- 학력 필터 -->
            <if test="filter.education != null and filter.education != ''">
                AND (p.JOB_EDUCATION = #{filter.education} OR p.JOB_EDUCATION_EXCLUDE = 'Y')
            </if>
            
            <!-- 학력무관 필터 -->
            <if test="filter.educationExclude != null and filter.educationExclude == true">
                AND p.JOB_EDUCATION_EXCLUDE = 'Y'
            </if>
            
            <!-- 업종 필터 -->
            <if test="filter.industries != null and filter.industries.size() > 0">
                AND (
                <foreach collection="filter.industries" item="industry" separator=" OR ">
                    p.JOB_INDUSTRIES LIKE '%' || #{industry} || '%'
                </foreach>
                )
            </if>
            
            <!-- 기업형태 필터 -->
            <if test="filter.companyTypes != null and filter.companyTypes.size() > 0">
                AND (
                <foreach collection="filter.companyTypes" item="companyType" separator=" OR ">
                    p.JOB_COMPANY_TYPES LIKE '%' || #{companyType} || '%'
                </foreach>
                )
            </if>
            
            <!-- 근무형태 필터 -->
            <if test="filter.workTypes != null and filter.workTypes.size() > 0">
                AND (
                <foreach collection="filter.workTypes" item="workType" separator=" OR ">
                    p.JOB_WORK_TYPES LIKE '%' || #{workType} || '%'
                </foreach>
                )
            </if>
            
            <!-- 근무요일 필터 -->
            <if test="filter.workDays != null and filter.workDays.size() > 0">
                AND (
                <foreach collection="filter.workDays" item="workDay" separator=" OR ">
                    p.JOB_WORK_DAYS LIKE '%' || #{workDay} || '%'
                </foreach>
                )
            </if>
            
            <!-- 최소 급여 필터 -->
            <if test="filter.salaryMin != null">
                AND (p.JOB_SALARY_MAX >= #{filter.salaryMin} OR p.JOB_SALARY_MAX IS NULL)
            </if>
            
            <!-- 키워드 검색 -->
            <if test="filter.keyword != null and filter.keyword != ''">
                AND (
                    UPPER(p.TITLE) LIKE '%' || UPPER(#{filter.keyword}) || '%'
                    OR UPPER(p.CONTENT) LIKE '%' || UPPER(#{filter.keyword}) || '%'
                    OR UPPER(c.COMPANY_NAME) LIKE '%' || UPPER(#{filter.keyword}) || '%'
                )
            </if>
        </where>
    </sql>
    
    <!-- 정렬 조건 -->
    <sql id="sortCondition">
        <choose>
            <when test="filter.sort == 'views'">
                ORDER BY p.VIEW_CNT DESC, p.CREATED_AT DESC
            </when>
            <when test="filter.sort == 'deadline'">
                ORDER BY p.JOB_DEADLINE ASC, p.CREATED_AT DESC
            </when>
            <otherwise>
                ORDER BY p.CREATED_AT DESC
            </otherwise>
        </choose>
    </sql>
    
    <!-- 채용공고 목록 조회 -->
    <select id="findJobs" parameterType="map" resultMap="JobResultMap">
        SELECT
            p.POST_ID,
            p.COMPANY_NUM,
            c.COMPANY_NAME,
            NULL AS COMPANY_IMAGE,
            p.COMPANY_LOGO,
            p.COMPANY_PHONE,
            p.TITLE,
            p.CONTENT,
            p.CREATED_AT,
            p.UPDATED_AT,
            p.VIEW_CNT,
            p.JOB_REGION,
            p.JOB_CAREER_TYPE,
            p.JOB_CAREER_YEARS,
            p.JOB_EDUCATION,
            p.JOB_EDUCATION_EXCLUDE,
            p.JOB_SALARY_MIN,
            p.JOB_SALARY_MAX,
            p.JOB_DEADLINE,
            p.JOB_STATUS,
            p.JOB_INDUSTRIES,
            p.JOB_COMPANY_TYPES,
            p.JOB_WORK_TYPES,
            p.JOB_WORK_DAYS
        FROM POST p
        JOIN COMPANY c ON p.COMPANY_NUM = c.COMPANY_NUM
        <include refid="filterConditions"/>
        <include refid="sortCondition"/>
        OFFSET #{filter.offset} ROWS FETCH NEXT #{filter.limit} ROWS ONLY
    </select>
    
    <!-- 채용공고 총 개수 -->
    <select id="countJobs" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM POST p
        JOIN COMPANY c ON p.COMPANY_NUM = c.COMPANY_NUM
        <include refid="filterConditions"/>
    </select>
    
    <!-- 채용공고 상세 조회 -->
    <select id="findJobById" parameterType="long" resultMap="JobResultMap">
        SELECT
            p.POST_ID,
            p.COMPANY_NUM,
            c.COMPANY_NAME,
            NULL AS COMPANY_IMAGE,
            p.COMPANY_LOGO,
            p.COMPANY_PHONE,
            p.TITLE,
            p.CONTENT,
            p.CREATED_AT,
            p.UPDATED_AT,
            p.VIEW_CNT,
            p.JOB_REGION,
            p.JOB_CAREER_TYPE,
            p.JOB_CAREER_YEARS,
            p.JOB_EDUCATION,
            p.JOB_EDUCATION_EXCLUDE,
            p.JOB_SALARY_MIN,
            p.JOB_SALARY_MAX,
            p.JOB_DEADLINE,
            p.JOB_STATUS,
            p.JOB_INDUSTRIES,
            p.JOB_COMPANY_TYPES,
            p.JOB_WORK_TYPES,
            p.JOB_WORK_DAYS
        FROM POST p
        JOIN COMPANY c ON p.COMPANY_NUM = c.COMPANY_NUM
        WHERE p.POST_ID = #{postId}
          AND p.BOARD_TYPE = 'job'
    </select>
    
    <!-- 채용공고 생성 -->
    <insert id="insertJob" parameterType="com.portflux.backend.dto.JobDto" useGeneratedKeys="true" keyProperty="postId" keyColumn="POST_ID">
        INSERT INTO POST (
            BOARD_TYPE,
            COMPANY_NUM,
            TITLE,
            CONTENT,
            JOB_REGION,
            JOB_CAREER_TYPE,
            JOB_CAREER_YEARS,
            JOB_EDUCATION,
            JOB_EDUCATION_EXCLUDE,
            JOB_SALARY_MIN,
            JOB_SALARY_MAX,
            JOB_DEADLINE,
            JOB_STATUS,
            JOB_INDUSTRIES,
            JOB_COMPANY_TYPES,
            JOB_WORK_TYPES,
            JOB_WORK_DAYS,
            COMPANY_LOGO,
            COMPANY_PHONE
        ) VALUES (
            'job',
            #{job.companyNum},
            #{job.title},
            #{job.content},
            #{job.jobRegion},
            #{job.jobCareerType, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            #{job.jobCareerYears, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            #{job.jobEducation},
            #{job.jobEducationExclude, typeHandler=org.apache.ibatis.type.BooleanTypeHandler},
            #{job.jobSalaryMin},
            #{job.jobSalaryMax},
            #{job.jobDeadline},
            #{job.jobStatus},
            #{job.jobIndustries, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            #{job.jobCompanyTypes, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            #{job.jobWorkTypes, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            #{job.jobWorkDays, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            #{job.companyLogo},
            #{job.companyPhone}
        )
    </insert>
    
    <!-- 채용공고 수정 -->
    <update id="updateJob" parameterType="com.portflux.backend.dto.JobDto">
        UPDATE POST SET
            TITLE = #{job.title},
            CONTENT = #{job.content},
            JOB_REGION = #{job.jobRegion},
            JOB_CAREER_TYPE = #{job.jobCareerType, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            JOB_CAREER_YEARS = #{job.jobCareerYears, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            JOB_EDUCATION = #{job.jobEducation},
            JOB_EDUCATION_EXCLUDE = #{job.jobEducationExclude, typeHandler=org.apache.ibatis.type.BooleanTypeHandler},
            JOB_SALARY_MIN = #{job.jobSalaryMin},
            JOB_SALARY_MAX = #{job.jobSalaryMax},
            JOB_DEADLINE = #{job.jobDeadline},
            JOB_STATUS = #{job.jobStatus},
            JOB_INDUSTRIES = #{job.jobIndustries, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            JOB_COMPANY_TYPES = #{job.jobCompanyTypes, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            JOB_WORK_TYPES = #{job.jobWorkTypes, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            JOB_WORK_DAYS = #{job.jobWorkDays, typeHandler=com.portflux.backend.handler.JsonArrayTypeHandler},
            COMPANY_LOGO = #{job.companyLogo},
            COMPANY_PHONE = #{job.companyPhone}
        WHERE POST_ID = #{job.postId}
          AND BOARD_TYPE = 'job'
    </update>
    
    <!-- 채용공고 삭제 -->
    <delete id="deleteJob" parameterType="long">
        DELETE FROM POST
        WHERE POST_ID = #{postId}
          AND BOARD_TYPE = 'job'
    </delete>
    
    <!-- 채용공고 상태 변경 -->
    <update id="updateJobStatus">
        UPDATE POST SET
            JOB_STATUS = #{status}
        WHERE POST_ID = #{postId}
          AND BOARD_TYPE = 'job'
    </update>
    
    <!-- 조회수 증가 -->
    <update id="incrementViewCount" parameterType="long">
        UPDATE POST SET
            VIEW_CNT = VIEW_CNT + 1
        WHERE POST_ID = #{postId}
    </update>
    
    <!-- 북마크 추가 (일반 사용자) -->
    <insert id="insertBookmark">
        INSERT INTO POST_SAVE (USER_NUM, POST_ID)
        VALUES (#{userNum}, #{postId})
    </insert>

    <!-- 북마크 추가 (기업 회원) -->
    <insert id="insertCompanyBookmark">
        INSERT INTO POST_SAVE (COMPANY_NUM, POST_ID)
        VALUES (#{companyNum}, #{postId})
    </insert>

    <!-- 북마크 삭제 (일반 사용자) -->
    <delete id="deleteBookmark">
        DELETE FROM POST_SAVE
        WHERE USER_NUM = #{userNum}
          AND POST_ID = #{postId}
    </delete>

    <!-- 북마크 삭제 (기업 회원) -->
    <delete id="deleteCompanyBookmark">
        DELETE FROM POST_SAVE
        WHERE COMPANY_NUM = #{companyNum}
          AND POST_ID = #{postId}
    </delete>

    <!-- 북마크 존재 여부 (일반 사용자) -->
    <select id="existsBookmark" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM POST_SAVE
        WHERE USER_NUM = #{userNum}
          AND POST_ID = #{postId}
    </select>

    <!-- 북마크 존재 여부 (기업 회원) -->
    <select id="existsCompanyBookmark" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM POST_SAVE
        WHERE COMPANY_NUM = #{companyNum}
          AND POST_ID = #{postId}
    </select>
    
    <!-- 북마크 목록 조회 -->
    <select id="findBookmarks" resultMap="JobResultMap">
        SELECT
            p.POST_ID,
            p.COMPANY_NUM,
            c.COMPANY_NAME,
            NULL AS COMPANY_IMAGE,
            p.COMPANY_LOGO,
            p.COMPANY_PHONE,
            p.TITLE,
            p.CONTENT,
            p.CREATED_AT,
            p.UPDATED_AT,
            p.VIEW_CNT,
            p.JOB_REGION,
            p.JOB_CAREER_TYPE,
            p.JOB_CAREER_YEARS,
            p.JOB_EDUCATION,
            p.JOB_EDUCATION_EXCLUDE,
            p.JOB_SALARY_MIN,
            p.JOB_SALARY_MAX,
            p.JOB_DEADLINE,
            p.JOB_STATUS,
            p.JOB_INDUSTRIES,
            p.JOB_COMPANY_TYPES,
            p.JOB_WORK_TYPES,
            p.JOB_WORK_DAYS
        FROM POST p
        JOIN COMPANY c ON p.COMPANY_NUM = c.COMPANY_NUM
        JOIN POST_SAVE ps ON p.POST_ID = ps.POST_ID
        WHERE ps.USER_NUM = #{userNum}
          AND p.BOARD_TYPE = 'job'
        ORDER BY ps.BOARD_SAVE_TIME DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>
    
    <!-- 북마크 개수 (일반 사용자) -->
    <select id="countBookmarks" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM POST_SAVE ps
        JOIN POST p ON ps.POST_ID = p.POST_ID
        WHERE ps.USER_NUM = #{userNum}
          AND p.BOARD_TYPE = 'job'
    </select>

    <!-- 북마크 목록 조회 (기업 회원) -->
    <select id="findCompanyBookmarks" resultMap="JobResultMap">
        SELECT
            p.POST_ID,
            p.COMPANY_NUM,
            c.COMPANY_NAME,
            NULL AS COMPANY_IMAGE,
            p.COMPANY_LOGO,
            p.COMPANY_PHONE,
            p.TITLE,
            p.CONTENT,
            p.CREATED_AT,
            p.UPDATED_AT,
            p.VIEW_CNT,
            p.JOB_REGION,
            p.JOB_CAREER_TYPE,
            p.JOB_CAREER_YEARS,
            p.JOB_EDUCATION,
            p.JOB_EDUCATION_EXCLUDE,
            p.JOB_SALARY_MIN,
            p.JOB_SALARY_MAX,
            p.JOB_DEADLINE,
            p.JOB_STATUS,
            p.JOB_INDUSTRIES,
            p.JOB_COMPANY_TYPES,
            p.JOB_WORK_TYPES,
            p.JOB_WORK_DAYS
        FROM POST p
        JOIN COMPANY c ON p.COMPANY_NUM = c.COMPANY_NUM
        JOIN POST_SAVE ps ON p.POST_ID = ps.POST_ID
        WHERE ps.COMPANY_NUM = #{companyNum}
          AND p.BOARD_TYPE = 'job'
        ORDER BY ps.BOARD_SAVE_TIME DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- 북마크 개수 (기업 회원) -->
    <select id="countCompanyBookmarks" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM POST_SAVE ps
        JOIN POST p ON ps.POST_ID = p.POST_ID
        WHERE ps.COMPANY_NUM = #{companyNum}
          AND p.BOARD_TYPE = 'job'
    </select>

    <!-- 지역별 채용공고 개수 -->
    <select id="countJobsByRegion" resultType="map">
        SELECT 
            JOB_REGION,
            COUNT(*) AS JOB_COUNT
        FROM POST
        WHERE BOARD_TYPE = 'job'
          AND JOB_STATUS = 'ACTIVE'
          AND JOB_DEADLINE >= TRUNC(SYSDATE)
          AND JOB_REGION IS NOT NULL
        GROUP BY JOB_REGION
    </select>
    
    <!-- 내 채용공고 목록 -->
    <select id="findMyJobs" resultMap="JobResultMap">
        SELECT
            p.POST_ID,
            p.COMPANY_NUM,
            c.COMPANY_NAME,
            NULL AS COMPANY_IMAGE,
            p.COMPANY_LOGO,
            p.COMPANY_PHONE,
            p.TITLE,
            p.CONTENT,
            p.CREATED_AT,
            p.UPDATED_AT,
            p.VIEW_CNT,
            p.JOB_REGION,
            p.JOB_CAREER_TYPE,
            p.JOB_CAREER_YEARS,
            p.JOB_EDUCATION,
            p.JOB_EDUCATION_EXCLUDE,
            p.JOB_SALARY_MIN,
            p.JOB_SALARY_MAX,
            p.JOB_DEADLINE,
            p.JOB_STATUS,
            p.JOB_INDUSTRIES,
            p.JOB_COMPANY_TYPES,
            p.JOB_WORK_TYPES,
            p.JOB_WORK_DAYS
        FROM POST p
        JOIN COMPANY c ON p.COMPANY_NUM = c.COMPANY_NUM
        WHERE p.COMPANY_NUM = #{companyNum}
          AND p.BOARD_TYPE = 'job'
        ORDER BY p.CREATED_AT DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>
    
    <!-- 내 채용공고 개수 -->
    <select id="countMyJobs" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM POST
        WHERE COMPANY_NUM = #{companyNum}
          AND BOARD_TYPE = 'job'
    </select>
    
    <!-- 만료된 공고 상태 변경 -->
    <update id="expireJobs">
        UPDATE POST SET
            JOB_STATUS = 'EXPIRED'
        WHERE BOARD_TYPE = 'job'
          AND JOB_STATUS = 'ACTIVE'
          AND JOB_DEADLINE &lt; TRUNC(SYSDATE)
    </update>
    
    <!-- 소유자 확인 -->
    <select id="isJobOwner" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM POST
        WHERE POST_ID = #{postId}
          AND COMPANY_NUM = #{companyNum}
          AND BOARD_TYPE = 'job'
    </select>
    
</mapper>